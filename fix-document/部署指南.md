# AIMS 2.0 åç«¯æœåŠ¡éƒ¨ç½²æŒ‡å—

## ä¸€ã€æ‰“åŒ…åº”ç”¨

åœ¨æœ¬åœ°Macä¸Šæ‰§è¡Œæ‰“åŒ…å‘½ä»¤ï¼š

```bash
cd /Users/eason/Documents/AIMSé¡¹ç›®/AIMS_2.0/cretas-backend-system
mvn clean package -DskipTests
```

æ‰“åŒ…å®Œæˆåï¼ŒJARæ–‡ä»¶ä½ç½®ï¼š
```
target/cretas-backend-system-1.0.0.jar
```

---

## äºŒã€ä¸Šä¼ åˆ°æœåŠ¡å™¨

### æ–¹å¼1: ä½¿ç”¨scpå‘½ä»¤

```bash
# åœ¨Macæœ¬åœ°æ‰§è¡Œ
scp target/cretas-backend-system-1.0.0.jar root@47.251.121.76:/opt/aims/
```

### æ–¹å¼2: ä½¿ç”¨SFTPå·¥å…·
- ä½¿ç”¨FileZillaã€Transmitç­‰å·¥å…·
- è¿æ¥åˆ° 47.251.121.76
- ä¸Šä¼ åˆ° `/opt/aims/` ç›®å½•

---

## ä¸‰ã€æœåŠ¡å™¨éƒ¨ç½²æ­¥éª¤

### 1. ç™»å½•æœåŠ¡å™¨

```bash
ssh root@47.251.121.76
```

### 2. åˆ›å»ºåº”ç”¨ç›®å½•

```bash
# åˆ›å»ºç›®å½•ç»“æ„
mkdir -p /opt/aims/{logs,config}
cd /opt/aims
```

### 3. æ£€æŸ¥å¹¶åœæ­¢æ—§æœåŠ¡

```bash
# æ–¹æ³•1: é€šè¿‡ç«¯å£æŸ¥æ‰¾å¹¶kill
lsof -ti:10010 | xargs kill -9 2>/dev/null && echo "âœ… å·²åœæ­¢æ—§æœåŠ¡" || echo "â„¹ï¸ æ²¡æœ‰è¿è¡Œä¸­çš„æœåŠ¡"

# æ–¹æ³•2: é€šè¿‡è¿›ç¨‹åæŸ¥æ‰¾
ps aux | grep cretas-backend-system | grep -v grep
# å¦‚æœæœ‰è¿›ç¨‹ï¼Œè®°ä¸‹PIDï¼Œç„¶åæ‰§è¡Œï¼š
# kill -9 <PID>

# æ–¹æ³•3: ä½¿ç”¨pkill
pkill -9 -f cretas-backend-system
```

### 4. æ£€æŸ¥Javaç‰ˆæœ¬

```bash
java -version
```

**è¦æ±‚**: Java 8 æˆ–æ›´é«˜ç‰ˆæœ¬

å¦‚æœæœªå®‰è£…Javaï¼š
```bash
# CentOS/RedHat
yum install java-1.8.0-openjdk -y

# Ubuntu/Debian
apt-get update
apt-get install openjdk-8-jdk -y
```

### 5. æ£€æŸ¥ä¾èµ–æœåŠ¡

#### æ£€æŸ¥MySQL
```bash
docker ps | grep mysql
# åº”è¯¥çœ‹åˆ°mysql8å®¹å™¨è¿è¡Œåœ¨3307ç«¯å£
```

#### æ£€æŸ¥Redis
```bash
redis-cli ping
# åº”è¯¥è¿”å›: PONG
```

---

## å››ã€å¯åŠ¨åº”ç”¨

### æ–¹å¼1: åå°è¿è¡Œï¼ˆæ¨èç”Ÿäº§ç¯å¢ƒï¼‰

åˆ›å»ºå¯åŠ¨è„šæœ¬ `/opt/aims/start.sh`:

```bash
#!/bin/bash
# AIMSåç«¯æœåŠ¡å¯åŠ¨è„šæœ¬

APP_NAME="cretas-backend-system"
APP_VERSION="1.0.0"
APP_JAR="/opt/aims/${APP_NAME}-${APP_VERSION}.jar"
LOG_DIR="/opt/aims/logs"
PID_FILE="/opt/aims/${APP_NAME}.pid"

# ç¡®ä¿æ—¥å¿—ç›®å½•å­˜åœ¨
mkdir -p ${LOG_DIR}

# æ£€æŸ¥æ˜¯å¦å·²ç»åœ¨è¿è¡Œ
if [ -f "$PID_FILE" ]; then
    PID=$(cat $PID_FILE)
    if ps -p $PID > /dev/null 2>&1; then
        echo "âŒ åº”ç”¨å·²ç»åœ¨è¿è¡Œ (PID: $PID)"
        exit 1
    else
        echo "âš ï¸  åˆ é™¤è¿‡æœŸçš„PIDæ–‡ä»¶"
        rm -f $PID_FILE
    fi
fi

# å¯åŠ¨åº”ç”¨
echo "ğŸš€ å¯åŠ¨ ${APP_NAME}..."
nohup java -jar \
    -Xms512m \
    -Xmx1024m \
    -Dserver.port=10010 \
    -Dspring.profiles.active=prod \
    ${APP_JAR} \
    > ${LOG_DIR}/application.log 2>&1 &

# ä¿å­˜PID
echo $! > ${PID_FILE}
echo "âœ… åº”ç”¨å·²å¯åŠ¨ (PID: $(cat $PID_FILE))"
echo "ğŸ“‹ æ—¥å¿—æ–‡ä»¶: ${LOG_DIR}/application.log"
echo ""
echo "æŸ¥çœ‹æ—¥å¿—: tail -f ${LOG_DIR}/application.log"
```

èµ‹äºˆæ‰§è¡Œæƒé™å¹¶è¿è¡Œï¼š
```bash
chmod +x /opt/aims/start.sh
/opt/aims/start.sh
```

### æ–¹å¼2: ä½¿ç”¨systemdæœåŠ¡ï¼ˆæ¨èï¼‰

åˆ›å»ºæœåŠ¡æ–‡ä»¶ `/etc/systemd/system/aims-backend.service`:

```ini
[Unit]
Description=AIMS Backend System
After=network.target mysql.service redis.service

[Service]
Type=simple
User=root
WorkingDirectory=/opt/aims
ExecStart=/usr/bin/java -jar \
    -Xms512m \
    -Xmx1024m \
    -Dserver.port=10010 \
    -Dspring.profiles.active=prod \
    /opt/aims/cretas-backend-system-1.0.0.jar
SuccessExitStatus=143
Restart=on-failure
RestartSec=10
StandardOutput=append:/opt/aims/logs/application.log
StandardError=append:/opt/aims/logs/error.log

[Install]
WantedBy=multi-user.target
```

å¯ç”¨å¹¶å¯åŠ¨æœåŠ¡ï¼š
```bash
# é‡æ–°åŠ è½½systemdé…ç½®
systemctl daemon-reload

# å¯åŠ¨æœåŠ¡
systemctl start aims-backend

# æŸ¥çœ‹çŠ¶æ€
systemctl status aims-backend

# è®¾ç½®å¼€æœºè‡ªå¯
systemctl enable aims-backend

# æŸ¥çœ‹æ—¥å¿—
journalctl -u aims-backend -f
```

systemdæœåŠ¡ç®¡ç†å‘½ä»¤ï¼š
```bash
# å¯åŠ¨æœåŠ¡
systemctl start aims-backend

# åœæ­¢æœåŠ¡
systemctl stop aims-backend

# é‡å¯æœåŠ¡
systemctl restart aims-backend

# æŸ¥çœ‹çŠ¶æ€
systemctl status aims-backend

# æŸ¥çœ‹æ—¥å¿—
journalctl -u aims-backend -f --lines=100
```

---

## äº”ã€éªŒè¯éƒ¨ç½²

### 1. æ£€æŸ¥è¿›ç¨‹

```bash
ps aux | grep cretas-backend-system | grep -v grep
```

### 2. æ£€æŸ¥ç«¯å£

```bash
netstat -tlnp | grep 10010
# æˆ–
lsof -i:10010
```

### 3. æŸ¥çœ‹æ—¥å¿—

```bash
# å®æ—¶æŸ¥çœ‹æ—¥å¿—
tail -f /opt/aims/logs/application.log

# æŸ¥çœ‹å¯åŠ¨æ—¥å¿—
grep "Started CretasApplication" /opt/aims/logs/application.log
```

### 4. æµ‹è¯•API

```bash
# æµ‹è¯•å¥åº·æ£€æŸ¥ï¼ˆå¦‚æœé…ç½®äº†ï¼‰
curl http://localhost:10010/actuator/health

# æµ‹è¯•ç™»å½•æ¥å£
curl -X POST http://localhost:10010/api/auth/platform-login \
  -H 'Content-Type: application/json' \
  -d '{"username":"platform_admin","password":"123456"}'
```

---

## å…­ã€åœæ­¢åº”ç”¨

### ä½¿ç”¨å¯åŠ¨è„šæœ¬åœæ­¢

åˆ›å»ºåœæ­¢è„šæœ¬ `/opt/aims/stop.sh`:

```bash
#!/bin/bash
# AIMSåç«¯æœåŠ¡åœæ­¢è„šæœ¬

APP_NAME="cretas-backend-system"
PID_FILE="/opt/aims/${APP_NAME}.pid"

if [ ! -f "$PID_FILE" ]; then
    echo "âŒ PIDæ–‡ä»¶ä¸å­˜åœ¨ï¼Œå°è¯•é€šè¿‡ç«¯å£åœæ­¢..."
    lsof -ti:10010 | xargs kill -15 2>/dev/null && echo "âœ… å·²åœæ­¢æœåŠ¡" || echo "â„¹ï¸ æ²¡æœ‰è¿è¡Œä¸­çš„æœåŠ¡"
    exit 0
fi

PID=$(cat $PID_FILE)

if ! ps -p $PID > /dev/null 2>&1; then
    echo "âš ï¸  è¿›ç¨‹ä¸å­˜åœ¨ï¼Œåˆ é™¤PIDæ–‡ä»¶"
    rm -f $PID_FILE
    exit 0
fi

echo "ğŸ›‘ åœæ­¢ ${APP_NAME} (PID: $PID)..."
kill -15 $PID

# ç­‰å¾…è¿›ç¨‹ä¼˜é›…å…³é—­
for i in {1..30}; do
    if ! ps -p $PID > /dev/null 2>&1; then
        echo "âœ… åº”ç”¨å·²åœæ­¢"
        rm -f $PID_FILE
        exit 0
    fi
    sleep 1
done

# å¦‚æœ30ç§’åè¿˜æ²¡åœæ­¢ï¼Œå¼ºåˆ¶kill
echo "âš ï¸  å¼ºåˆ¶åœæ­¢åº”ç”¨"
kill -9 $PID
rm -f $PID_FILE
echo "âœ… åº”ç”¨å·²å¼ºåˆ¶åœæ­¢"
```

èµ‹äºˆæ‰§è¡Œæƒé™ï¼š
```bash
chmod +x /opt/aims/stop.sh
```

### ä½¿ç”¨systemdåœæ­¢

```bash
systemctl stop aims-backend
```

---

## ä¸ƒã€é‡å¯åº”ç”¨

### æ–¹å¼1: ä½¿ç”¨è„šæœ¬

```bash
/opt/aims/stop.sh
sleep 3
/opt/aims/start.sh
```

æˆ–åˆ›å»ºé‡å¯è„šæœ¬ `/opt/aims/restart.sh`:

```bash
#!/bin/bash
/opt/aims/stop.sh
sleep 3
/opt/aims/start.sh
```

### æ–¹å¼2: ä½¿ç”¨systemd

```bash
systemctl restart aims-backend
```

---

## å…«ã€æ—¥å¿—ç®¡ç†

### æ—¥å¿—æ–‡ä»¶ä½ç½®
```
/opt/aims/logs/application.log  # åº”ç”¨æ—¥å¿—
/opt/aims/logs/error.log        # é”™è¯¯æ—¥å¿—ï¼ˆä½¿ç”¨systemdæ—¶ï¼‰
```

### æ—¥å¿—æŸ¥çœ‹å‘½ä»¤

```bash
# æŸ¥çœ‹æœ€å100è¡Œ
tail -100 /opt/aims/logs/application.log

# å®æ—¶ç›‘æ§
tail -f /opt/aims/logs/application.log

# æœç´¢é”™è¯¯
grep -i error /opt/aims/logs/application.log

# æŸ¥çœ‹å¯åŠ¨ä¿¡æ¯
grep "Started CretasApplication" /opt/aims/logs/application.log
```

### æ—¥å¿—æ¸…ç†

åˆ›å»ºæ—¥å¿—æ¸…ç†è„šæœ¬ `/opt/aims/clean-logs.sh`:

```bash
#!/bin/bash
# æ¸…ç†30å¤©å‰çš„æ—¥å¿—

LOG_DIR="/opt/aims/logs"
DAYS=30

echo "ğŸ§¹ æ¸…ç†${DAYS}å¤©å‰çš„æ—¥å¿—æ–‡ä»¶..."
find ${LOG_DIR} -name "*.log" -type f -mtime +${DAYS} -delete
echo "âœ… æ¸…ç†å®Œæˆ"
```

è®¾ç½®å®šæ—¶ä»»åŠ¡ï¼ˆæ¯å‘¨æ‰§è¡Œï¼‰ï¼š
```bash
crontab -e
# æ·»åŠ ï¼š
0 2 * * 0 /opt/aims/clean-logs.sh >> /opt/aims/logs/clean.log 2>&1
```

---

## ä¹ã€é…ç½®æ–‡ä»¶

### ç”Ÿäº§ç¯å¢ƒé…ç½®

å¦‚éœ€è‡ªå®šä¹‰é…ç½®ï¼Œåˆ›å»º `/opt/aims/config/application-prod.yml`:

```yaml
server:
  port: 10010

spring:
  datasource:
    url: jdbc:mysql://47.251.121.76:3307/cretas?useUnicode=true&characterEncoding=utf-8&useSSL=true
    username: root
    password: Zyh123456

  redis:
    host: 47.251.121.76
    port: 6379
    password: 123456
    database: 0

logging:
  level:
    com.cretas.aims: INFO
    root: WARN
  file:
    name: /opt/aims/logs/application.log
    max-size: 100MB
    max-history: 30
```

å¯åŠ¨æ—¶æŒ‡å®šé…ç½®ï¼š
```bash
java -jar \
  -Dspring.config.location=/opt/aims/config/application-prod.yml \
  /opt/aims/cretas-backend-system-1.0.0.jar
```

---

## åã€å¸¸è§é—®é¢˜

### 1. ç«¯å£è¢«å ç”¨

```bash
# æŸ¥çœ‹å ç”¨ç«¯å£çš„è¿›ç¨‹
lsof -i:10010
# æˆ–
netstat -tlnp | grep 10010

# åœæ­¢è¿›ç¨‹
kill -9 <PID>
```

### 2. å†…å­˜ä¸è¶³

è°ƒæ•´JVMå‚æ•°ï¼š
```bash
java -jar -Xms256m -Xmx512m cretas-backend-system-1.0.0.jar
```

### 3. æ— æ³•è¿æ¥æ•°æ®åº“

æ£€æŸ¥ï¼š
```bash
# MySQLæ˜¯å¦è¿è¡Œ
docker ps | grep mysql

# ç«¯å£æ˜¯å¦å¼€æ”¾
telnet 47.251.121.76 3307

# é˜²ç«å¢™è®¾ç½®
firewall-cmd --list-ports
```

### 4. Redisè¿æ¥å¤±è´¥

```bash
# æ£€æŸ¥Redis
redis-cli ping

# æ£€æŸ¥å¯†ç 
redis-cli -a 123456 ping
```

### 5. æŸ¥çœ‹å®Œæ•´é”™è¯¯ä¿¡æ¯

```bash
# æŸ¥çœ‹åº”ç”¨æ—¥å¿—
tail -200 /opt/aims/logs/application.log

# æŸ¥çœ‹ç³»ç»Ÿæ—¥å¿—ï¼ˆsystemdï¼‰
journalctl -u aims-backend -n 200
```

---

## åä¸€ã€å®Œæ•´éƒ¨ç½²æµç¨‹ç¤ºä¾‹

```bash
# 1. ç™»å½•æœåŠ¡å™¨
ssh root@47.251.121.76

# 2. åˆ›å»ºç›®å½•
mkdir -p /opt/aims/{logs,config}
cd /opt/aims

# 3. åœæ­¢æ—§æœåŠ¡
lsof -ti:10010 | xargs kill -9 2>/dev/null || echo "æ²¡æœ‰è¿è¡Œä¸­çš„æœåŠ¡"

# 4. ä¸Šä¼ æ–°JARï¼ˆåœ¨æœ¬åœ°Macæ‰§è¡Œï¼‰
# scp target/cretas-backend-system-1.0.0.jar root@47.251.121.76:/opt/aims/

# 5. æ£€æŸ¥Java
java -version

# 6. åˆ›å»ºå¯åŠ¨è„šæœ¬ï¼ˆå‚è€ƒç¬¬å››èŠ‚ï¼‰
vim /opt/aims/start.sh
chmod +x /opt/aims/start.sh

# 7. å¯åŠ¨åº”ç”¨
/opt/aims/start.sh

# 8. æŸ¥çœ‹æ—¥å¿—
tail -f /opt/aims/logs/application.log

# 9. æµ‹è¯•API
curl -X POST http://localhost:10010/api/auth/platform-login \
  -H 'Content-Type: application/json' \
  -d '{"username":"platform_admin","password":"123456"}'
```

---

## åäºŒã€ç›‘æ§ä¸ç»´æŠ¤

### æ€§èƒ½ç›‘æ§

```bash
# æŸ¥çœ‹JVMå†…å­˜ä½¿ç”¨
jstat -gc <PID> 1000

# æŸ¥çœ‹çº¿ç¨‹
jstack <PID>

# æŸ¥çœ‹ç³»ç»Ÿèµ„æº
top -p <PID>
```

### å®šæœŸç»´æŠ¤

1. æ¯å‘¨é‡å¯ä¸€æ¬¡ï¼ˆæ¸…ç†å†…å­˜ï¼‰
2. æ¯æœˆæ£€æŸ¥æ—¥å¿—å¤§å°
3. å®šæœŸå¤‡ä»½æ•°æ®åº“
4. ç›‘æ§ç£ç›˜ç©ºé—´

---

## é™„å½•ï¼šå¿«é€Ÿå‘½ä»¤å‚è€ƒ

```bash
# å¯åŠ¨
systemctl start aims-backend
# æˆ–
/opt/aims/start.sh

# åœæ­¢
systemctl stop aims-backend
# æˆ–
/opt/aims/stop.sh

# é‡å¯
systemctl restart aims-backend

# æŸ¥çœ‹çŠ¶æ€
systemctl status aims-backend
# æˆ–
ps aux | grep cretas-backend-system

# æŸ¥çœ‹æ—¥å¿—
tail -f /opt/aims/logs/application.log
# æˆ–
journalctl -u aims-backend -f

# æ£€æŸ¥ç«¯å£
lsof -i:10010
```

---

**éƒ¨ç½²å®Œæˆåï¼Œè®¿é—®åœ°å€**:
- API Base URL: `http://47.251.121.76:10010`
- Swaggeræ–‡æ¡£: `http://47.251.121.76:10010/swagger-ui.html`

**æµ‹è¯•è´¦å·**:
- å¹³å°ç®¡ç†å‘˜: `platform_admin` / `123456`
- å·¥å‚ç”¨æˆ·: `testadmin` / `123456` (factoryId: F001)
