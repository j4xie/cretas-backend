# Cretas AIMS 2.0 登录注册流程说明

## 文档版本信息
- **版本**: v1.0
- **更新日期**: 2025-10-09
- **适用系统**: Cretas 食品溯源系统 (AIMS 2.0)
- **后端项目**: cretas-backend-system
- **API基础URL**: `http://localhost:8080`

---

## 一、系统概述

### 1.1 用户类型

系统支持两种用户类型：

1. **工厂用户** (Factory Users)
   - 工厂超级管理员 (factory_super_admin)
   - 权限管理员 (permission_admin)
   - 部门管理员 (department_admin)
   - 操作员 (operator)
   - 查看者 (viewer)

2. **移动端用户** (Mobile Users)
   - 通过移动端APP登录的工厂员工
   - 支持设备激活和管理

### 1.2 认证机制

- **Token类型**: JWT (JSON Web Token)
- **Token有效期**: 24小时
- **RefreshToken有效期**: 30天
- **密码加密**: BCrypt
- **Session管理**: 数据库持久化

---

## 二、登录流程

### 2.1 工厂用户登录流程

#### 流程图
```
用户打开登录页面
    ↓
输入工厂ID + 用户名 + 密码
    ↓
调用 POST /api/auth/login
    ↓
后端验证用户名密码
    ↓
生成 AccessToken + RefreshToken
    ↓
创建Session会话记录
    ↓
返回用户信息 + 权限列表 + Token
    ↓
前端存储Token到localStorage/sessionStorage
    ↓
跳转到系统首页
```

#### 接口调用顺序

**步骤1: 用户登录**
```http
POST /api/auth/login
Content-Type: application/json

Request Body:
{
  "factoryId": "TEST_2024_001",
  "username": "factory_admin",
  "password": "SuperAdmin@123"
}

Response (200 OK):
{
  "success": true,
  "message": "登录成功",
  "data": {
    "token": "eyJhbGciOiJIUzUxMiJ9...",
    "refreshToken": "550e8400-e29b-41d4-a716-446655440000",
    "tokenType": "Bearer",
    "expiresIn": 86400,
    "user": {
      "id": 1,
      "factoryId": "TEST_2024_001",
      "username": "factory_admin",
      "fullName": "工厂管理员",
      "email": "admin@factory.com",
      "phone": "+8613800000000",
      "roleCode": "factory_super_admin",
      "department": "管理部",
      "isActive": true,
      "avatar": null,
      "lastLoginAt": "2025-10-09T10:30:00"
    },
    "permissions": {
      "modules": [
        "user_management",
        "production_management",
        "inventory_management",
        "report_management"
      ],
      "features": [
        "user:create",
        "user:update",
        "user:delete",
        "production:manage",
        "inventory:manage",
        "report:view"
      ]
    }
  },
  "timestamp": "2025-10-09T10:30:00"
}
```

**步骤2: 后续请求携带Token**
```http
GET /api/auth/me
Authorization: Bearer eyJhbGciOiJIUzUxMiJ9...

Response (200 OK):
{
  "success": true,
  "data": {
    "id": 1,
    "username": "factory_admin",
    "fullName": "工厂管理员",
    ...
  }
}
```

**步骤3: Token过期时刷新**
```http
POST /api/auth/refresh?refreshToken=550e8400-e29b-41d4-a716-446655440000

Response (200 OK):
{
  "success": true,
  "message": "令牌刷新成功",
  "data": {
    "token": "eyJhbGciOiJIUzUxMiJ9...(new)",
    "refreshToken": "660e8400-e29b-41d4-a716-446655440001(new)",
    "tokenType": "Bearer",
    "expiresIn": 86400,
    "user": {...}
  }
}
```

**步骤4: 用户登出**
```http
POST /api/auth/logout
Authorization: Bearer eyJhbGciOiJIUzUxMiJ9...

Response (200 OK):
{
  "success": true,
  "message": "登出成功",
  "data": null
}
```

### 2.2 移动端用户登录流程

#### 流程图
```
用户打开移动APP
    ↓
【首次使用】输入激活码激活设备
    ↓
调用 POST /api/mobile/activation/activate
    ↓
设备激活成功，返回工厂信息
    ↓
输入用户名 + 密码 + 设备信息
    ↓
调用 POST /api/mobile/auth/unified-login
    ↓
后端验证用户名密码
    ↓
记录设备信息（型号、OS、版本等）
    ↓
生成 AccessToken + RefreshToken
    ↓
返回用户信息 + Token
    ↓
前端存储Token到SecureStore
    ↓
跳转到移动端首页
```

#### 接口调用顺序

**步骤1: 设备激活（首次使用）**
```http
POST /api/mobile/activation/activate
Content-Type: application/json

Request Body:
{
  "activationCode": "CRETAS_MOBILE_2024",
  "deviceId": "DEVICE_123456",
  "deviceInfo": {
    "deviceId": "DEVICE_123456",
    "deviceModel": "iPhone 14 Pro",
    "deviceType": "iOS",
    "osVersion": "17.0",
    "appVersion": "1.0.0"
  }
}

Response (200 OK):
{
  "success": true,
  "data": {
    "activated": true,
    "factoryId": "TEST_2024_001",
    "factoryName": "测试工厂",
    "expiresAt": "2025-12-31T23:59:59",
    "message": "设备激活成功"
  }
}
```

**步骤2: 统一登录**
```http
POST /api/mobile/auth/unified-login
Content-Type: application/json

Request Body:
{
  "username": "processing_admin",
  "password": "DeptAdmin@123",
  "deviceInfo": {
    "deviceId": "DEVICE_123456",
    "deviceModel": "iPhone 14 Pro",
    "deviceType": "iOS",
    "osVersion": "17.0",
    "appVersion": "1.0.0"
  }
}

Response (200 OK):
{
  "success": true,
  "data": {
    "token": "eyJhbGciOiJIUzUxMiJ9...",
    "refreshToken": "770e8400-e29b-41d4-a716-446655440000",
    "tokenType": "Bearer",
    "expiresIn": 86400,
    "userProfile": {
      "userId": 5,
      "username": "processing_admin",
      "fullName": "加工部经理",
      "factoryId": "TEST_2024_001",
      "department": "加工部",
      "role": "department_admin",
      "avatar": null,
      "permissions": [
        "production:manage",
        "batch:create",
        "batch:update"
      ]
    }
  }
}
```

**步骤3: Token过期时刷新**
```http
POST /api/mobile/auth/refresh?refreshToken=770e8400-e29b-41d4-a716-446655440000

Response (200 OK):
{
  "success": true,
  "data": {
    "token": "eyJhbGciOiJIUzUxMiJ9...(new)",
    "refreshToken": "880e8400-e29b-41d4-a716-446655440001(new)",
    ...
  }
}
```

**步骤4: 用户登出**
```http
POST /api/mobile/auth/logout?deviceId=DEVICE_123456
Authorization: Bearer eyJhbGciOiJIUzUxMiJ9...

Response (200 OK):
{
  "success": true,
  "message": "登出成功",
  "data": null
}
```

---

## 三、注册流程

### 3.1 当前状态

⚠️ **注意**: 注册功能**尚未完整实现**，仅有部分基础接口。

### 3.2 计划中的注册流程（移动端）

#### 两阶段注册流程
```
用户打开注册页面
    ↓
【第一阶段】手机号验证
    ↓
输入手机号
    ↓
调用 POST /api/mobile/auth/send-code（已实现）
    ↓
接收短信验证码
    ↓
输入验证码
    ↓
调用 POST /api/mobile/auth/verify-code（已实现）
    ↓
验证通过，获取tempToken
    ↓
【第二阶段】完整信息填写
    ↓
输入用户名、密码、姓名、部门等
    ↓
调用 POST /api/mobile/auth/register-phase-two（未实现）
    ↓
后端验证白名单
    ↓
创建用户账号（状态：待激活）
    ↓
管理员审核激活
    ↓
用户可正常登录
```

#### 当前可用的接口

**发送验证码**
```http
POST /api/mobile/auth/send-code?phoneNumber=+8613800000000

Response (200 OK):
{
  "success": true,
  "data": true,
  "message": "验证码已发送"
}

注意：当前验证码仅打印在服务器日志中，未真实发送短信
```

**验证验证码**
```http
POST /api/mobile/auth/verify-code?phoneNumber=+8613800000000&code=123456

Response (200 OK):
{
  "success": true,
  "data": true,
  "message": "验证成功"
}
```

### 3.3 需要实现的接口

以下接口需要开发：

1. `POST /api/auth/verify-phone` - 工厂用户手机验证
2. `POST /api/auth/register` - 工厂用户注册
3. `POST /api/mobile/auth/register-phase-one` - 移动端注册第一步
4. `POST /api/mobile/auth/register-phase-two` - 移动端注册第二步

---

## 四、Token管理

### 4.1 Token存储建议

#### Web前端（工厂用户）
```javascript
// 登录成功后存储
localStorage.setItem('accessToken', response.data.token);
localStorage.setItem('refreshToken', response.data.refreshToken);
localStorage.setItem('user', JSON.stringify(response.data.user));

// 每次请求携带
axios.defaults.headers.common['Authorization'] = `Bearer ${localStorage.getItem('accessToken')}`;

// 登出时清除
localStorage.removeItem('accessToken');
localStorage.removeItem('refreshToken');
localStorage.removeItem('user');
```

#### 移动端（React Native）
```javascript
import * as SecureStore from 'expo-secure-store';

// 登录成功后存储（安全存储）
await SecureStore.setItemAsync('accessToken', response.data.token);
await SecureStore.setItemAsync('refreshToken', response.data.refreshToken);
await AsyncStorage.setItem('user', JSON.stringify(response.data.userProfile));

// 每次请求携带
const token = await SecureStore.getItemAsync('accessToken');
axios.defaults.headers.common['Authorization'] = `Bearer ${token}`;

// 登出时清除
await SecureStore.deleteItemAsync('accessToken');
await SecureStore.deleteItemAsync('refreshToken');
await AsyncStorage.removeItem('user');
```

### 4.2 Token自动刷新机制

#### 推荐的实现方式（Axios拦截器）

```javascript
import axios from 'axios';

// 创建axios实例
const apiClient = axios.create({
  baseURL: 'http://localhost:8080',
  timeout: 10000
});

// 请求拦截器：添加Token
apiClient.interceptors.request.use(
  async (config) => {
    const token = await getAccessToken(); // 从存储中获取
    if (token) {
      config.headers.Authorization = `Bearer ${token}`;
    }
    return config;
  },
  (error) => Promise.reject(error)
);

// 响应拦截器：自动刷新Token
apiClient.interceptors.response.use(
  (response) => response,
  async (error) => {
    const originalRequest = error.config;

    // Token过期（401错误）且未重试过
    if (error.response?.status === 401 && !originalRequest._retry) {
      originalRequest._retry = true;

      try {
        const refreshToken = await getRefreshToken();

        // 调用刷新Token接口
        const response = await axios.post(
          'http://localhost:8080/api/auth/refresh',
          null,
          { params: { refreshToken } }
        );

        const newToken = response.data.data.token;
        const newRefreshToken = response.data.data.refreshToken;

        // 存储新Token
        await saveAccessToken(newToken);
        await saveRefreshToken(newRefreshToken);

        // 重试原请求
        originalRequest.headers.Authorization = `Bearer ${newToken}`;
        return apiClient(originalRequest);
      } catch (refreshError) {
        // RefreshToken也过期，跳转登录页
        await clearTokens();
        window.location.href = '/login';
        return Promise.reject(refreshError);
      }
    }

    return Promise.reject(error);
  }
);

export default apiClient;
```

### 4.3 Token过期处理策略

| 场景 | 处理方式 |
|------|---------|
| AccessToken过期 | 使用RefreshToken自动刷新 |
| RefreshToken过期 | 跳转登录页，要求重新登录 |
| Token无效（被篡改） | 返回401错误，跳转登录页 |
| Session被撤销 | 返回401错误，跳转登录页 |
| 修改密码后 | 撤销所有Session，要求重新登录 |

---

## 五、权限验证

### 5.1 权限数据结构

登录成功后返回的权限数据：

```json
{
  "permissions": {
    "modules": [
      "user_management",
      "production_management",
      "inventory_management",
      "report_management",
      "system_settings"
    ],
    "features": [
      "user:create",
      "user:update",
      "user:delete",
      "user:view",
      "production:create",
      "production:manage",
      "inventory:view",
      "inventory:manage",
      "report:view",
      "report:export"
    ]
  }
}
```

### 5.2 前端权限验证示例

#### React示例
```jsx
import { useAuth } from './hooks/useAuth';

function UserManagementPage() {
  const { hasPermission } = useAuth();

  return (
    <div>
      <h1>用户管理</h1>

      {hasPermission('user:create') && (
        <button onClick={handleCreateUser}>创建用户</button>
      )}

      {hasPermission('user:delete') && (
        <button onClick={handleDeleteUser}>删除用户</button>
      )}
    </div>
  );
}

// hooks/useAuth.js
export function useAuth() {
  const user = JSON.parse(localStorage.getItem('user'));

  const hasPermission = (feature) => {
    return user?.permissions?.features?.includes(feature);
  };

  const hasModule = (module) => {
    return user?.permissions?.modules?.includes(module);
  };

  return { user, hasPermission, hasModule };
}
```

#### Vue示例
```vue
<template>
  <div>
    <h1>用户管理</h1>

    <button v-if="hasPermission('user:create')" @click="createUser">
      创建用户
    </button>

    <button v-if="hasPermission('user:delete')" @click="deleteUser">
      删除用户
    </button>
  </div>
</template>

<script setup>
import { computed } from 'vue';
import { useUserStore } from '@/stores/user';

const userStore = useUserStore();

const hasPermission = (feature) => {
  return userStore.permissions.features.includes(feature);
};
</script>
```

---

## 六、错误处理

### 6.1 常见错误码

| HTTP状态码 | 错误类型 | 说明 | 处理方式 |
|-----------|---------|------|---------|
| 401 | AUTHENTICATION_ERROR | Token无效或过期 | 尝试刷新Token，失败则跳转登录页 |
| 403 | AUTHORIZATION_ERROR | 权限不足 | 显示权限不足提示，禁用操作 |
| 400 | VALIDATION_ERROR | 请求参数错误 | 显示具体错误信息 |
| 404 | NOT_FOUND_ERROR | 资源不存在 | 显示404页面 |
| 409 | CONFLICT_ERROR | 数据冲突（如用户名重复） | 显示冲突提示 |
| 500 | INTERNAL_SERVER_ERROR | 服务器错误 | 显示通用错误提示，记录日志 |

### 6.2 错误响应格式

```json
{
  "success": false,
  "message": "用户名或密码错误",
  "code": "AUTHENTICATION_ERROR",
  "timestamp": "2025-10-09T10:30:00"
}
```

### 6.3 前端错误处理示例

```javascript
async function login(factoryId, username, password) {
  try {
    const response = await apiClient.post('/api/auth/login', {
      factoryId,
      username,
      password
    });

    if (response.data.success) {
      // 登录成功
      await saveTokens(response.data.data);
      return { success: true, data: response.data.data };
    }
  } catch (error) {
    // 处理错误
    if (error.response) {
      const { status, data } = error.response;

      switch (status) {
        case 401:
          return {
            success: false,
            message: data.message || '用户名或密码错误'
          };
        case 403:
          return {
            success: false,
            message: '账号已被禁用，请联系管理员'
          };
        case 500:
          return {
            success: false,
            message: '服务器错误，请稍后重试'
          };
        default:
          return {
            success: false,
            message: data.message || '登录失败'
          };
      }
    } else {
      // 网络错误
      return {
        success: false,
        message: '网络连接失败，请检查网络设置'
      };
    }
  }
}
```

---

## 七、安全建议

### 7.1 前端安全最佳实践

1. **Token存储**
   - Web端：使用localStorage（可考虑httpOnly Cookie）
   - 移动端：使用SecureStore加密存储
   - 不要将Token存储在URL参数中

2. **密码处理**
   - 前端不要明文存储密码
   - 使用HTTPS传输
   - 登录失败不要提示具体是用户名还是密码错误

3. **XSS防护**
   - 对用户输入进行转义
   - 使用CSP（Content Security Policy）
   - 不要使用`dangerouslySetInnerHTML`

4. **CSRF防护**
   - 后端已使用JWT，前端需确保Token不被跨站访问
   - 敏感操作需要二次确认

### 7.2 移动端安全建议

1. **证书固定** (Certificate Pinning)
   ```javascript
   // 仅接受特定证书的服务器
   import { configurePinning } from 'react-native-cert-pinner';

   configurePinning({
     'api.cretas.com': {
       includeSubdomains: true,
       pins: ['sha256/AAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAA=']
     }
   });
   ```

2. **防止Root/越狱检测**
   ```javascript
   import JailMonkey from 'jail-monkey';

   if (JailMonkey.isJailBroken()) {
     alert('检测到设备已越狱，部分功能将不可用');
   }
   ```

3. **防止截屏**
   ```javascript
   import ScreenshotPreventer from 'react-native-screenshot-prevent';

   ScreenshotPreventer.enabled(true); // 敏感页面启用
   ```

---

## 八、测试账号

### 8.1 工厂用户测试账号

| 用户名 | 密码 | 角色 | 工厂ID | 说明 |
|-------|------|------|--------|------|
| factory_admin | SuperAdmin@123 | 工厂超级管理员 | TEST_2024_001 | 全部权限 |
| permission_admin | PermAdmin@123 | 权限管理员 | TEST_2024_001 | 用户管理权限 |
| farming_admin | DeptAdmin@123 | 部门管理员（养殖） | TEST_2024_001 | 养殖部管理 |
| processing_admin | DeptAdmin@123 | 部门管理员（加工） | TEST_2024_001 | 加工部管理 |
| logistics_admin | DeptAdmin@123 | 部门管理员（物流） | TEST_2024_001 | 物流部管理 |

### 8.2 移动端测试

**设备激活码**:
- `DEV_TEST_2024`
- `CRETAS_MOBILE_2024`
- `PROD_ACTIVATION`

**登录账号**: 使用上述工厂用户账号（只需用户名+密码，无需工厂ID）

---

## 九、常见问题（FAQ）

### Q1: Token过期后如何处理？
A: 使用RefreshToken自动刷新AccessToken，无需用户重新登录。如果RefreshToken也过期，则需要重新登录。

### Q2: 支持多设备同时登录吗？
A: 支持。每个设备/浏览器都会创建独立的Session，可以同时有效。

### Q3: 修改密码后是否需要重新登录？
A: 是的。修改密码后会撤销所有Session，所有设备需要重新登录。

### Q4: 移动端登录为什么不需要工厂ID？
A: 移动端使用统一登录接口，后端会自动查找用户所属工厂。但当前实现有bug，建议添加工厂ID参数。

### Q5: 忘记密码怎么办？
A: 当前系统需要管理员调用重置密码接口。未来会添加手机验证码重置功能。

### Q6: 如何验证Token是否有效？
A: 调用`GET /api/auth/validate`接口，或在业务接口被401拒绝时尝试刷新Token。

### Q7: 登出后Token还有效吗？
A: 无效。登出会撤销Session，后端会拒绝该Token的所有请求。

### Q8: 注册功能何时可用？
A: 注册功能尚未完整实现，预计在后续版本中提供。

---

## 十、版本更新记录

### v1.0 (2025-10-09)
- ✅ 完成工厂用户登录流程
- ✅ 完成移动端登录流程
- ✅ 完成Token刷新机制
- ✅ 完成设备激活流程
- ⚠️ 注册功能待开发
- ⚠️ 手机验证码仅模拟实现

---

## 十一、联系方式

- **技术支持**: support@cretas.com
- **API文档**: http://localhost:8080/swagger-ui.html
- **GitHub Issues**: https://github.com/cretas/aims/issues

---

**文档维护**: Cretas Team
**最后更新**: 2025-10-09
