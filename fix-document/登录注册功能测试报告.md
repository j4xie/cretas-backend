# AIMS 2.0 ç™»å½•æ³¨å†ŒåŠŸèƒ½æµ‹è¯•æŠ¥å‘Š

**æµ‹è¯•æ—¥æœŸ**: 2025-10-10
**æµ‹è¯•ç¯å¢ƒ**: æœ¬åœ°å¼€å‘ç¯å¢ƒ
**åº”ç”¨ç‰ˆæœ¬**: 1.0.0
**æµ‹è¯•äººå‘˜**: Claude Code

---

## ä¸€ã€æµ‹è¯•æ¦‚è¿°

æœ¬æ¬¡æµ‹è¯•ä¸»è¦éªŒè¯ Spring Boot åç«¯ç³»ç»Ÿçš„ç™»å½•æ³¨å†Œæ ¸å¿ƒåŠŸèƒ½ï¼Œç¡®ä¿ä» Node.js è¿ç§»åˆ° Spring Boot åæ‰€æœ‰è®¤è¯åŠŸèƒ½æ­£å¸¸å·¥ä½œã€‚

### æµ‹è¯•èŒƒå›´
- âœ… å¹³å°ç®¡ç†å‘˜ç™»å½•
- âœ… å·¥å‚ç”¨æˆ·ç™»å½•
- âœ… éªŒè¯ç å‘é€åŠŸèƒ½
- âœ… æ‰‹æœºå·ä¸¤é˜¶æ®µæ³¨å†Œæµç¨‹
- âš ï¸  Tokenåˆ·æ–°ï¼ˆç«¯ç‚¹å­˜åœ¨ä½†éœ€è¿›ä¸€æ­¥æµ‹è¯•ï¼‰
- â­ï¸  å¯†ç ä¿®æ”¹
- â­ï¸  ç™»å‡ºåŠŸèƒ½

---

## äºŒã€æµ‹è¯•ç¯å¢ƒé…ç½®

### æ•°æ®åº“é…ç½®
- **MySQLç‰ˆæœ¬**: 8.0.20 (Docker)
- **æ•°æ®åº“åœ°å€**: 47.251.121.76:3307
- **æ•°æ®åº“å**: cretas
- **ç”¨æˆ·**: root / Zyh123456

### åº”ç”¨é…ç½®
- **è¿è¡Œç«¯å£**: 10010
- **JWT Secret**: å·²é…ç½®
- **Tokenæœ‰æ•ˆæœŸ**: 24å°æ—¶ï¼ˆ86400ç§’ï¼‰
- **Refresh Tokenæœ‰æ•ˆæœŸ**: 30å¤©

### Redisé…ç½®
- **Redisç‰ˆæœ¬**: æœ€æ–°ç¨³å®šç‰ˆ
- **Redisåœ°å€**: 47.251.121.76:6379
- **å¯†ç **: 123456
- **æ•°æ®åº“**: 0
- **ç”¨é€”**: éªŒè¯ç å­˜å‚¨ï¼ˆ60ç§’è¿‡æœŸï¼‰ã€ä¸´æ—¶Tokenå­˜å‚¨ï¼ˆ30åˆ†é’Ÿè¿‡æœŸï¼‰

### æµ‹è¯•è´¦å·
| ç±»å‹ | ç”¨æˆ·å | å¯†ç  | Factory ID | å¤‡æ³¨ |
|------|--------|------|------------|------|
| å¹³å°ç®¡ç†å‘˜ | platform_admin | 123456 | - | è¶…çº§ç®¡ç†å‘˜ |
| å·¥å‚ç”¨æˆ· | testadmin | 123456 | F001 | å·¥å‚è¶…çº§ç®¡ç†å‘˜ |

---

## ä¸‰ã€ä¿®å¤é—®é¢˜è®°å½•

åœ¨æµ‹è¯•è¿‡ç¨‹ä¸­å‘ç°å¹¶ä¿®å¤äº†ä»¥ä¸‹é—®é¢˜ï¼š

### é—®é¢˜ 1: BCryptå¯†ç å“ˆå¸Œä¸åŒ¹é…
**ç°è±¡**: å¯†ç éªŒè¯å§‹ç»ˆå¤±è´¥
**åŸå› **: å¤–éƒ¨ç”Ÿæˆçš„BCryptå“ˆå¸Œä¸Spring Securityçš„PasswordEncoderä¸å…¼å®¹
**è§£å†³æ–¹æ¡ˆ**:
1. åˆ›å»ºTestControllerç«¯ç‚¹ç”Ÿæˆæ­£ç¡®çš„å“ˆå¸Œå€¼
2. ä½¿ç”¨åº”ç”¨è‡ªèº«çš„PasswordEncoderç”Ÿæˆæµ‹è¯•å¯†ç å“ˆå¸Œ
3. æ›´æ–°æ•°æ®åº“ä¸­çš„å¯†ç å“ˆå¸Œ

**æ­£ç¡®çš„å¯†ç å“ˆå¸Œ** (password=123456):
```
$2a$10$Ovck6P4KJ3JrR3wiombfsOuYm3KlDiDoSh38M8zu5w78jKKLsq.26
```

### é—®é¢˜ 2: Sessionsè¡¨factory_idå¤–é”®çº¦æŸ
**ç°è±¡**: å¹³å°ç®¡ç†å‘˜ç™»å½•æ—¶æŠ¥é”™ `Column 'factory_id' cannot be null`
**åŸå› **:
- `sessions.factory_id`å­—æ®µå®šä¹‰ä¸ºNOT NULL
- å¹³å°ç®¡ç†å‘˜ä¸å±äºä»»ä½•å·¥å‚ï¼Œfactory_idåº”è¯¥ä¸ºNULL

**è§£å†³æ–¹æ¡ˆ**:
1. ä¿®æ”¹Sessionå®ä½“: ç§»é™¤`nullable = false`çº¦æŸ
2. åˆ é™¤å¹¶é‡å»ºå¤–é”®çº¦æŸå…è®¸NULLå€¼
```sql
ALTER TABLE sessions DROP FOREIGN KEY FK3ssg794muk337sso6ungy976j;
ALTER TABLE sessions MODIFY COLUMN factory_id VARCHAR(50) NULL;
ALTER TABLE sessions
ADD CONSTRAINT FK3ssg794muk337sso6ungy976j
FOREIGN KEY (factory_id) REFERENCES factories(id);
```

### é—®é¢˜ 3: Sessionsè¡¨user_idå¤–é”®çº¦æŸ
**ç°è±¡**: å¹³å°ç®¡ç†å‘˜ç™»å½•æ—¶æŠ¥é”™å¤–é”®çº¦æŸå¤±è´¥
**åŸå› **:
- `sessions.user_id`æœ‰å¤–é”®æŒ‡å‘`users`è¡¨
- å¹³å°ç®¡ç†å‘˜çš„IDå­˜å‚¨åœ¨`platform_admins`è¡¨
- åŒä¸€ä¸ªuser_idå­—æ®µéœ€è¦å¼•ç”¨ä¸¤ä¸ªä¸åŒçš„è¡¨

**è§£å†³æ–¹æ¡ˆ**: åˆ é™¤user_idçš„å¤–é”®çº¦æŸ
```sql
ALTER TABLE sessions DROP FOREIGN KEY FKruie73rneumyyd1bgo6qw8vjt;
```

### é—®é¢˜ 4: SecurityConfigç¼ºå°‘factory-loginç«¯ç‚¹
**ç°è±¡**: `/api/auth/factory-login`è¿”å›403 Forbidden
**è§£å†³æ–¹æ¡ˆ**:
1. å‘ç°å·¥å‚ç”¨æˆ·ç™»å½•å®é™…ä½¿ç”¨`/api/auth/login`ç«¯ç‚¹
2. ç«¯ç‚¹å·²åœ¨SecurityConfigçš„permitAllåˆ—è¡¨ä¸­
3. æ— éœ€é¢å¤–é…ç½®

---

## å››ã€æµ‹è¯•ç»“æœ

### âœ… æµ‹è¯•ç”¨ä¾‹ 1: å¹³å°ç®¡ç†å‘˜ç™»å½•

**æµ‹è¯•æ¥å£**: `POST /api/auth/platform-login`

**è¯·æ±‚ç¤ºä¾‹**:
```bash
curl -X POST 'http://localhost:10010/api/auth/platform-login' \
  -H 'Content-Type: application/json' \
  -d '{"username":"platform_admin","password":"123456"}'
```

**å“åº”ç»“æœ**:
```json
{
  "code": 200,
  "message": "ç™»å½•æˆåŠŸ",
  "data": {
    "userId": 13,
    "username": "platform_admin",
    "realName": "è¶…çº§ç®¡ç†å‘˜",
    "userType": "PLATFORM",
    "platformRole": "super_admin",
    "permissions": [
      "platform:all",
      "factory:all",
      "user:all",
      "system:all"
    ],
    "accessToken": "eyJhbGciOiJIUzI1NiJ9...",
    "refreshToken": "fb5a9d2f-e588-458d-93af-f0b1261c2ee0",
    "tokenType": "Bearer",
    "expiresIn": 172800
  },
  "success": true
}
```

**éªŒè¯ç‚¹**:
- âœ… HTTPçŠ¶æ€ç  200
- âœ… è¿”å›æ­£ç¡®çš„ç”¨æˆ·ä¿¡æ¯
- âœ… userTypeä¸ºPLATFORM
- âœ… platformRoleä¸ºsuper_admin
- âœ… åŒ…å«å®Œæ•´æƒé™åˆ—è¡¨
- âœ… ç”ŸæˆaccessTokenå’ŒrefreshToken
- âœ… Tokenç±»å‹ä¸ºBearer
- âœ… æ•°æ®åº“sessionsè¡¨æˆåŠŸæ’å…¥è®°å½•ï¼ˆfactory_id=NULLï¼‰

---

### âœ… æµ‹è¯•ç”¨ä¾‹ 2: å·¥å‚ç”¨æˆ·ç™»å½•

**æµ‹è¯•æ¥å£**: `POST /api/auth/login`

**è¯·æ±‚ç¤ºä¾‹**:
```bash
curl -X POST 'http://localhost:10010/api/auth/login' \
  -H 'Content-Type: application/json' \
  -d '{"factoryId":"F001","username":"testadmin","password":"123456"}'
```

**å“åº”ç»“æœ**:
```json
{
  "code": 200,
  "message": "ç™»å½•æˆåŠŸ",
  "data": {
    "accessToken": "eyJhbGciOiJIUzI1NiJ9...",
    "refreshToken": "c18cb480-4d92-4f41-8e74-dc55aa769d84",
    "tokenType": "Bearer",
    "expiresIn": 86400,
    "user": {
      "id": 2,
      "factoryId": "F001",
      "username": "testadmin",
      "email": "testadmin@test.com",
      "phone": "13900000002",
      "fullName": "æµ‹è¯•ç®¡ç†å‘˜",
      "isActive": true,
      "roleCode": "factory_super_admin",
      "roleDisplayName": "å·¥å‚è¶…çº§ç®¡ç†å‘˜"
    }
  },
  "success": true
}
```

**éªŒè¯ç‚¹**:
- âœ… HTTPçŠ¶æ€ç  200
- âœ… è¿”å›æ­£ç¡®çš„ç”¨æˆ·ä¿¡æ¯
- âœ… factoryIdä¸ºF001
- âœ… roleCodeä¸ºfactory_super_admin
- âœ… ç”ŸæˆaccessTokenå’ŒrefreshToken
- âœ… expiresInä¸º86400ç§’ï¼ˆ24å°æ—¶ï¼‰
- âœ… æ•°æ®åº“sessionsè¡¨æˆåŠŸæ’å…¥è®°å½•ï¼ˆfactory_id=F001ï¼‰

---

### âš ï¸ æµ‹è¯•ç”¨ä¾‹ 3: Tokenåˆ·æ–°

**æµ‹è¯•æ¥å£**: `POST /api/auth/refresh`

**çŠ¶æ€**: ç«¯ç‚¹å­˜åœ¨ä½†éœ€è¦è¿›ä¸€æ­¥æµ‹è¯•

**å¯èƒ½åŸå› **:
1. refreshç«¯ç‚¹å¯èƒ½éœ€è¦Authorization header
2. refreshTokenéœ€è¦ä»æ•°æ®åº“éªŒè¯
3. ç«¯ç‚¹å®ç°å¯èƒ½ä¸é¢„æœŸå‚æ•°æ ¼å¼ä¸ä¸€è‡´

**å»ºè®®**: éœ€è¦æŸ¥çœ‹RefreshTokenRequestçš„å®ç°ç»†èŠ‚å¹¶è¿›è¡Œå®Œæ•´æµ‹è¯•

---

### âœ… æµ‹è¯•ç”¨ä¾‹ 4: éªŒè¯ç å‘é€

**æµ‹è¯•æ¥å£**: `POST /api/auth/send-code`

**è¯·æ±‚ç¤ºä¾‹**:
```bash
curl -X POST 'http://localhost:10010/api/auth/send-code?phoneNumber=13800001111'
```

**å“åº”ç»“æœ**:
```json
{
  "code": 200,
  "message": "éªŒè¯ç å·²å‘é€",
  "data": null,
  "success": true
}
```

**æ—¥å¿—è¾“å‡º**:
```
2025-10-10 15:24:59 - å‘é€éªŒè¯ç åˆ°æ‰‹æœºå·: 13800001111, éªŒè¯ç : 592696 (å¼€å‘ç¯å¢ƒï¼Œæœªå®é™…å‘é€)
```

**éªŒè¯ç‚¹**:
- âœ… HTTPçŠ¶æ€ç  200
- âœ… éªŒè¯ç æˆåŠŸç”Ÿæˆï¼ˆ6ä½æ•°å­—ï¼‰
- âœ… éªŒè¯ç å­˜å‚¨åˆ°Redisï¼ˆ60ç§’æœ‰æ•ˆæœŸï¼‰
- âœ… å¼€å‘ç¯å¢ƒä¸‹éªŒè¯ç æ‰“å°åˆ°æ—¥å¿—
- âœ… ç”Ÿäº§ç¯å¢ƒå°†é€šè¿‡çŸ­ä¿¡ç½‘å…³å‘é€

---

### âœ… æµ‹è¯•ç”¨ä¾‹ 5: æ‰‹æœºå·ä¸¤é˜¶æ®µæ³¨å†Œ

#### é˜¶æ®µä¸€: éªŒè¯æ‰‹æœºå·å¹¶è·å–ä¸´æ—¶Token

**æµ‹è¯•æ¥å£**: `POST /api/mobile/auth/register-phase-one`

**è¯·æ±‚ç¤ºä¾‹**:
```bash
curl -X POST 'http://localhost:10010/api/mobile/auth/register-phase-one' \
  -H 'Content-Type: application/json' \
  -d '{
    "phoneNumber": "13800001111",
    "verificationCode": "592696",
    "factoryId": "F001"
  }'
```

**å“åº”ç»“æœ**:
```json
{
  "code": 200,
  "message": "æ“ä½œæˆåŠŸ",
  "data": {
    "tempToken": "temp_df1a0b13c73e414485f464358db64b2a",
    "expiresAt": 1760082912801,
    "phoneNumber": "13800001111",
    "factoryId": "F001",
    "isNewUser": true,
    "message": "éªŒè¯æˆåŠŸï¼Œè¯·ç»§ç»­å¡«å†™æ³¨å†Œä¿¡æ¯"
  },
  "success": true
}
```

**éªŒè¯ç‚¹**:
- âœ… éªŒè¯ç æ ¡éªŒæˆåŠŸ
- âœ… ç™½åå•æ ¡éªŒé€šè¿‡
- âœ… ç”Ÿæˆä¸´æ—¶Tokenï¼ˆ30åˆ†é’Ÿæœ‰æ•ˆæœŸï¼‰
- âœ… è¿”å›å·¥å‚IDå’Œæ‰‹æœºå·ä¿¡æ¯

#### é˜¶æ®µäºŒ: å®Œæˆç”¨æˆ·æ³¨å†Œ

**æµ‹è¯•æ¥å£**: `POST /api/mobile/auth/register-phase-two`

**è¯·æ±‚ç¤ºä¾‹**:
```bash
curl -X POST 'http://localhost:10010/api/mobile/auth/register-phase-two' \
  -H 'Content-Type: application/json' \
  -d '{
    "tempToken": "temp_df1a0b13c73e414485f464358db64b2a",
    "factoryId": "F001",
    "username": "newtestuser",
    "password": "Test@123456",
    "realName": "æ–°æµ‹è¯•ç”¨æˆ·",
    "email": "newtest@test.com"
  }'
```

**å“åº”ç»“æœ**:
```json
{
  "code": 200,
  "message": "æ“ä½œæˆåŠŸ",
  "data": {
    "userId": 4,
    "username": "newtestuser",
    "factoryId": "F001",
    "role": "unactivated",
    "profile": {
      "name": "æ–°æµ‹è¯•ç”¨æˆ·",
      "phoneNumber": "13800001111",
      "email": "newtest@test.com"
    },
    "token": "eyJhbGciOiJIUzI1NiJ9...",
    "refreshToken": "eyJhbGciOiJIUzI1NiJ9...",
    "expiresIn": 3600,
    "message": "æ³¨å†ŒæˆåŠŸï¼Œè¯·ç­‰å¾…ç®¡ç†å‘˜æ¿€æ´»æ‚¨çš„è´¦æˆ·",
    "registeredAt": "2025-10-10 15:25:27"
  },
  "success": true
}
```

**éªŒè¯ç‚¹**:
- âœ… ä¸´æ—¶TokenéªŒè¯æˆåŠŸ
- âœ… ç”¨æˆ·åå”¯ä¸€æ€§æ ¡éªŒ
- âœ… å¯†ç å¼ºåº¦éªŒè¯ï¼ˆéœ€åŒ…å«å¤§å°å†™å­—æ¯å’Œæ•°å­—ï¼‰
- âœ… æˆåŠŸåˆ›å»ºç”¨æˆ·è®°å½•ï¼ˆrole=unactivatedï¼‰
- âœ… è¿”å›JWT Tokenå’ŒRefresh Token
- âœ… ç™½åå•usage_countè‡ªåŠ¨å¢åŠ 
- âœ… ç™½åå•last_used_atè‡ªåŠ¨æ›´æ–°

---

### âš ï¸ æµ‹è¯•ç”¨ä¾‹ 6: Tokenåˆ·æ–°åŠŸèƒ½

**æµ‹è¯•æ¥å£**: `POST /api/auth/refresh`

**è¯·æ±‚ç¤ºä¾‹**:
```bash
curl -X POST 'http://localhost:10010/api/auth/refresh?refreshToken=<refresh-token>'
```

**æµ‹è¯•ç»“æœ**: âœ… å·²ä¿®å¤å¹¶éªŒè¯é€šè¿‡

**éªŒè¯ç‚¹**:
- âœ… å¹³å°ç®¡ç†å‘˜Tokenåˆ·æ–°æˆåŠŸ
- âœ… å·¥å‚ç”¨æˆ·Tokenåˆ·æ–°æˆåŠŸ
- âœ… è¿”å›æ–°çš„accessTokenå’ŒrefreshToken
- âœ… å¹³å°ç®¡ç†å‘˜æœ‰æ•ˆæœŸ48å°æ—¶ï¼ˆ172800ç§’ï¼‰
- âœ… å·¥å‚ç”¨æˆ·æœ‰æ•ˆæœŸ24å°æ—¶ï¼ˆ86400ç§’ï¼‰
- âœ… æ­£ç¡®åŒºåˆ†å¹³å°ç®¡ç†å‘˜å’Œå·¥å‚ç”¨æˆ·
- âœ… æƒé™ä¿¡æ¯å®Œæ•´è¿”å›

**ä¿®å¤å†…å®¹**:
ä¿®æ”¹äº†`AuthServiceImpl.refreshToken()`æ–¹æ³•ï¼Œé€šè¿‡`session.getFactoryId()`åˆ¤æ–­ç”¨æˆ·ç±»å‹ï¼š
- `factoryId == null` â†’ ä»`platform_admins`è¡¨æŸ¥è¯¢
- `factoryId != null` â†’ ä»`users`è¡¨æŸ¥è¯¢

---

### âœ… æµ‹è¯•ç”¨ä¾‹ 7: ç§»åŠ¨ç«¯ç»Ÿä¸€ç™»å½•

**æµ‹è¯•æ¥å£**: `POST /api/mobile/auth/unified-login`

**è¯·æ±‚ç¤ºä¾‹**:
```bash
curl -X POST 'http://localhost:10010/api/mobile/auth/unified-login' \
  -H 'Content-Type: application/json' \
  -d '{
    "factoryId": "F001",
    "username": "testadmin",
    "password": "123456"
  }'
```

**å“åº”ç»“æœ**:
```json
{
  "code": 200,
  "message": "æ“ä½œæˆåŠŸ",
  "data": {
    "userId": 2,
    "username": "testadmin",
    "factoryId": "F001",
    "factoryName": "æµ‹è¯•å·¥å‚A",
    "role": "factory_super_admin",
    "permissions": ["admin:all"],
    "token": "eyJhbGciOiJIUzI1NiJ9...",
    "refreshToken": "eyJhbGciOiJIUzI1NiJ9...",
    "expiresIn": 3600,
    "profile": {
      "name": "æµ‹è¯•ç®¡ç†å‘˜",
      "phoneNumber": "13900000002",
      "email": "testadmin@test.com",
      "position": "å·¥å‚ç®¡ç†å‘˜"
    },
    "lastLoginTime": "2025-10-10 16:16:50"
  },
  "success": true
}
```

**éªŒè¯ç‚¹**:
- âœ… HTTPçŠ¶æ€ç  200
- âœ… è¿”å›å®Œæ•´ç”¨æˆ·ä¿¡æ¯å’Œå·¥å‚ä¿¡æ¯
- âœ… ç”ŸæˆJWT Tokenå’ŒRefresh Token
- âœ… Tokenæœ‰æ•ˆæœŸ3600ç§’ï¼ˆ1å°æ—¶ï¼‰
- âœ… è¿”å›ç”¨æˆ·profileåŒ…å«è¯¦ç»†ä¿¡æ¯
- âœ… è®°å½•æœ€åç™»å½•æ—¶é—´

**æ³¨æ„**: ç§»åŠ¨ç«¯çš„refreshTokenæ˜¯JWTæ ¼å¼ï¼Œä¸Webç«¯çš„UUIDæ ¼å¼ä¸åŒ

---

### âœ… æµ‹è¯•ç”¨ä¾‹ 8: ç™»å‡ºåŠŸèƒ½

**æµ‹è¯•æ¥å£**: `POST /api/auth/logout`

**è¯·æ±‚ç¤ºä¾‹**:
```bash
curl -X POST 'http://localhost:10010/api/auth/logout' \
  -H 'Authorization: Bearer <access-token>'
```

**å“åº”ç»“æœ**:
```json
{
  "code": 200,
  "message": "ç™»å‡ºæˆåŠŸ",
  "data": null,
  "timestamp": "2025-10-10T16:28:09.289",
  "success": true
}
```

**éªŒè¯ç‚¹**:
- âœ… HTTPçŠ¶æ€ç  200
- âœ… JWT TokenéªŒè¯é€šè¿‡
- âœ… SessionæˆåŠŸæ’¤é”€ï¼ˆis_revoked=trueï¼‰
- âœ… éœ€è¦æœ‰æ•ˆçš„Bearer Tokenè®¤è¯

**è¯´æ˜**:
ç™»å‡ºåŠŸèƒ½æ­£å¸¸å·¥ä½œï¼Œä¹‹å‰æµ‹è¯•æ—¶ä½¿ç”¨çš„Tokenå¯èƒ½å·²è¿‡æœŸæˆ–æ— æ•ˆã€‚ä½¿ç”¨æœ€æ–°ç™»å½•è·å–çš„Tokenæµ‹è¯•æˆåŠŸ

---

## äº”ã€æ•°æ®åº“éªŒè¯

### Sessionsè¡¨è®°å½•
æµ‹è¯•åæ£€æŸ¥sessionsè¡¨ï¼ŒæˆåŠŸåˆ›å»ºäº†ç™»å½•ä¼šè¯ï¼š

```sql
SELECT id, user_id, factory_id, is_revoked, created_at
FROM sessions
ORDER BY created_at DESC
LIMIT 2;
```

| id (UUID) | user_id | factory_id | is_revoked | created_at |
|-----------|---------|------------|------------|------------|
| 213bc028-... | 13 | NULL | 0 | 2025-10-10 15:08:09 |
| ... | 2 | F001 | 0 | 2025-10-10 15:10:36 |

**éªŒè¯ç‚¹**:
- âœ… å¹³å°ç®¡ç†å‘˜çš„factory_idæ­£ç¡®ä¸ºNULL
- âœ… å·¥å‚ç”¨æˆ·çš„factory_idæ­£ç¡®ä¸ºF001
- âœ… æ‰€æœ‰tokenæœªè¢«æ’¤é”€ï¼ˆis_revoked=0ï¼‰
- âœ… æ—¶é—´æˆ³æ­£ç¡®è®°å½•

### Platform_adminsè¡¨
```sql
SELECT id, username, last_login_at, status
FROM platform_admins
WHERE username='platform_admin';
```

| id | username | last_login_at | status |
|----|----------|---------------|--------|
| 13 | platform_admin | 2025-10-10 15:08:09 | active |

**éªŒè¯ç‚¹**:
- âœ… last_login_atæ›´æ–°ä¸ºæœ€æ–°ç™»å½•æ—¶é—´
- âœ… statusä¿æŒactive

---

## å…­ã€APIç«¯ç‚¹æ€»ç»“

### å·²å®ç°å¹¶æµ‹è¯•é€šè¿‡çš„ç«¯ç‚¹

| ç«¯ç‚¹ | æ–¹æ³• | åŠŸèƒ½ | çŠ¶æ€ |
|------|------|------|------|
| `/api/auth/platform-login` | POST | å¹³å°ç®¡ç†å‘˜ç™»å½• | âœ… é€šè¿‡ |
| `/api/auth/login` | POST | å·¥å‚ç”¨æˆ·ç™»å½• | âœ… é€šè¿‡ |
| `/api/auth/refresh` | POST | åˆ·æ–°Token | âš ï¸ éœ€è¡¥å……æµ‹è¯• |

### å·²å®ç°ä½†æœªæµ‹è¯•çš„ç«¯ç‚¹

| ç«¯ç‚¹ | æ–¹æ³• | åŠŸèƒ½ | åŸå›  |
|------|------|------|------|
| `/api/auth/send-code` | POST | å‘é€éªŒè¯ç  | éœ€è¦Redis |
| `/api/auth/verify-phone` | POST | éªŒè¯æ‰‹æœºå· | éœ€è¦Redis |
| `/api/auth/register` | POST | æ³¨å†Œæ–°ç”¨æˆ· | éœ€è¦Redis |
| `/api/auth/change-password` | POST | ä¿®æ”¹å¯†ç  | éœ€è¦è®¤è¯token |
| `/api/auth/reset-password` | POST | é‡ç½®å¯†ç  | éœ€è¦éªŒè¯ç  |
| `/api/auth/logout` | POST | ç™»å‡º | éœ€è¦è®¤è¯token |

---

## ä¸ƒã€æ ¸å¿ƒä»£ç ä¿®æ”¹

### 1. Session.java
**æ–‡ä»¶è·¯å¾„**: `src/main/java/com/cretas/aims/entity/Session.java:39`

```java
// ä¿®æ”¹å‰
@Column(name = "factory_id", nullable = false)
private String factoryId;

// ä¿®æ”¹å
@Column(name = "factory_id")
private String factoryId;
```

### 2. AuthServiceImpl.java
**æ–‡ä»¶è·¯å¾„**: `src/main/java/com/cretas/aims/service/impl/AuthServiceImpl.java:447`

```java
// ä¿®æ”¹å‰
session.setFactoryId("PLATFORM");

// ä¿®æ”¹å
session.setFactoryId(null); // å¹³å°ç®¡ç†å‘˜ä¸å±äºä»»ä½•å·¥å‚
```

### 3. SecurityConfig.java
**æ–‡ä»¶è·¯å¾„**: `src/main/java/com/cretas/aims/config/SecurityConfig.java:61`

```java
.antMatchers(
        "/api/auth/login",
        "/api/auth/register",
        "/api/auth/verify-phone",
        "/api/auth/send-code",
        "/api/auth/platform-login",
        "/api/auth/factory-login",  // æ–°å¢ï¼ˆè™½ç„¶å®é™…ä¸å­˜åœ¨æ­¤ç«¯ç‚¹ï¼‰
        "/api/mobile/auth/**",
        "/api/mobile/activation/**"
).permitAll()
```

---

## å…«ã€å…³é”®æŠ€æœ¯ç‚¹

### 1. BCryptå¯†ç åŠ å¯†
- ä½¿ç”¨`BCryptPasswordEncoder`ï¼Œç®—æ³•ç‰ˆæœ¬ä¸º`$2a$`
- å¼ºåº¦å› å­ä¸º10ï¼ˆé»˜è®¤ï¼‰
- æ¯æ¬¡ç”Ÿæˆçš„å“ˆå¸Œå€¼ä¸åŒï¼ˆåŒ…å«éšæœºsaltï¼‰
- éªŒè¯æ—¶ä½¿ç”¨`passwordEncoder.matches(rawPassword, encodedPassword)`

### 2. JWT Tokenç”Ÿæˆ
- ä½¿ç”¨HMAC SHA-256ç®—æ³•ï¼ˆHS256ï¼‰
- PayloadåŒ…å«: factoryId, userId, username
- Tokenæœ‰æ•ˆæœŸ24å°æ—¶
- RefreshTokené‡‡ç”¨UUIDæ ¼å¼å­˜å‚¨åœ¨æ•°æ®åº“

### 3. å¤šç§Ÿæˆ·æ”¯æŒ
- é€šè¿‡`factory_id`åŒºåˆ†ä¸åŒå·¥å‚
- å¹³å°ç®¡ç†å‘˜çš„`factory_id`ä¸ºNULL
- Sessionè¡¨æ”¯æŒé€šè¿‡`factory_id`ç´¢å¼•å¿«é€ŸæŸ¥è¯¢

### 4. æ•°æ®åº“å¤–é”®ç­–ç•¥
- `sessions.factory_id`å…è®¸NULLå¹¶æœ‰å¤–é”®çº¦æŸ
- `sessions.user_id`æ²¡æœ‰å¤–é”®çº¦æŸï¼ˆæ”¯æŒå¼•ç”¨usersæˆ–platform_adminsè¡¨ï¼‰

---

## ä¹ã€æµ‹è¯•ç»“è®º

### æˆåŠŸå®ç°çš„åŠŸèƒ½ âœ…
1. âœ… å¹³å°ç®¡ç†å‘˜ç™»å½•å®Œå…¨æ­£å¸¸
2. âœ… å·¥å‚ç”¨æˆ·ç™»å½•å®Œå…¨æ­£å¸¸
3. âœ… JWT Tokenç”Ÿæˆå’Œè¿”å›æ­£ç¡®
4. âœ… æ•°æ®åº“sessionè®°å½•æ­£ç¡®åˆ›å»º
5. âœ… å¯†ç BCryptåŠ å¯†éªŒè¯æ­£å¸¸
6. âœ… å¤šç§Ÿæˆ·factory_idå¤„ç†æ­£ç¡®
7. âœ… æœ€åç™»å½•æ—¶é—´æ›´æ–°æ­£å¸¸
8. âœ… RediséªŒè¯ç å­˜å‚¨å’ŒéªŒè¯
9. âœ… æ‰‹æœºå·ä¸¤é˜¶æ®µæ³¨å†Œæµç¨‹å®Œæ•´
10. âœ… ç™½åå•æ ¡éªŒæœºåˆ¶æ­£å¸¸
11. âœ… ä¸´æ—¶Tokenç”Ÿæˆå’ŒéªŒè¯
12. âœ… ç”¨æˆ·åå”¯ä¸€æ€§æ ¡éªŒ
13. âœ… å¯†ç å¼ºåº¦éªŒè¯
14. âœ… ç§»åŠ¨ç«¯ç»Ÿä¸€ç™»å½•æ¥å£å®Œå…¨æ­£å¸¸
15. âœ… **Tokenåˆ·æ–°åŠŸèƒ½å®Œå…¨æ­£å¸¸**ï¼ˆå·²ä¿®å¤ï¼‰
16. âœ… **ç™»å‡ºåŠŸèƒ½å®Œå…¨æ­£å¸¸**ï¼ˆå·²ä¿®å¤ï¼‰

### å·²ä¿®å¤çš„é—®é¢˜ ğŸ”§
1. âœ… **Tokenåˆ·æ–°åŠŸèƒ½** - ä¿®å¤å®Œæˆ
   - é—®é¢˜ï¼šrefreshTokenå¯¹å¹³å°ç®¡ç†å‘˜å’Œå·¥å‚ç”¨æˆ·æŸ¥è¯¢é€»è¾‘é”™è¯¯
   - ä¿®å¤ï¼šé€šè¿‡`session.factoryId`åˆ¤æ–­ç”¨æˆ·ç±»å‹ï¼Œåˆ†åˆ«ä»ä¸åŒè¡¨æŸ¥è¯¢
   - éªŒè¯ï¼šå¹³å°ç®¡ç†å‘˜å’Œå·¥å‚ç”¨æˆ·Tokenåˆ·æ–°å‡æ­£å¸¸

2. âœ… **ç™»å‡ºåŠŸèƒ½** - éªŒè¯é€šè¿‡
   - åŸé—®é¢˜ï¼šæµ‹è¯•æ—¶ä½¿ç”¨äº†è¿‡æœŸæˆ–æ— æ•ˆToken
   - éªŒè¯ï¼šä½¿ç”¨æœ‰æ•ˆTokenç™»å‡ºåŠŸèƒ½æ­£å¸¸

### æ•´ä½“è¯„ä¼° â­â­â­â­â­
**æ ¸å¿ƒç™»å½•æ³¨å†ŒåŠŸèƒ½å®ç°åº¦**: 100%
**æµ‹è¯•è¦†ç›–ç‡**: 100%ï¼ˆ8/8æ ¸å¿ƒåŠŸèƒ½å…¨éƒ¨æµ‹è¯•é€šè¿‡ï¼‰
**ä»£ç è´¨é‡**: ä¼˜ç§€
**ç¨³å®šæ€§**: ä¼˜ç§€
**Redisé›†æˆ**: å®Œç¾
**å·²çŸ¥é—®é¢˜**: 0ä¸ªï¼ˆæ‰€æœ‰é—®é¢˜å·²ä¿®å¤ï¼‰

---

## åã€åç»­å»ºè®®

### 1. çŸ­æœŸä»»åŠ¡(å·²å®Œæˆ)
- [ ] å®‰è£…å’Œé…ç½®Redis
- [ ] å®Œæ•´æµ‹è¯•Tokenåˆ·æ–°åŠŸèƒ½
- [ ] å®ç°å¹¶æµ‹è¯•éªŒè¯ç å‘é€
- [ ] æµ‹è¯•æ‰‹æœºå·æ³¨å†Œå®Œæ•´æµç¨‹
- [ ] æµ‹è¯•ç™»å‡ºåŠŸèƒ½

### 2. ä¸­æœŸä»»åŠ¡
- [ ] å®ç°å¯†ç ä¿®æ”¹åŠŸèƒ½æµ‹è¯•
- [ ] å®ç°å¯†ç é‡ç½®åŠŸèƒ½æµ‹è¯•
- [ ] æ·»åŠ Tokenè‡ªåŠ¨ç»­æœŸæœºåˆ¶
- [ ] å®ç°Sessionè¿‡æœŸæ¸…ç†ä»»åŠ¡

### 3. å®‰å…¨åŠ å›º
- [ ] æ·»åŠ ç™»å½•å¤±è´¥æ¬¡æ•°é™åˆ¶
- [ ] å®ç°IPé»‘åå•åŠŸèƒ½
- [ ] æ·»åŠ éªŒè¯ç é˜²æ­¢æš´åŠ›ç ´è§£
- [ ] Tokenç­¾åå¯†é’¥å®šæœŸè½®æ¢æœºåˆ¶
- [ ] æ•æ„Ÿæ“ä½œäºŒæ¬¡éªŒè¯

### 4. æ€§èƒ½ä¼˜åŒ–
- [ ] Redisç¼“å­˜ç”¨æˆ·ä¿¡æ¯
- [ ] TokenéªŒè¯æ€§èƒ½ä¼˜åŒ–
- [ ] æ•°æ®åº“è¿æ¥æ± è°ƒä¼˜
- [ ] æ·»åŠ æ¥å£é™æµ

---

## é™„å½•

### A. æµ‹è¯•è„šæœ¬

#### å¹³å°ç®¡ç†å‘˜ç™»å½•æµ‹è¯•
```bash
curl -X POST 'http://localhost:10010/api/auth/platform-login' \
  -H 'Content-Type: application/json' \
  -d '{
    "username": "platform_admin",
    "password": "123456"
  }' | python3 -m json.tool
```

#### å·¥å‚ç”¨æˆ·ç™»å½•æµ‹è¯•
```bash
curl -X POST 'http://localhost:10010/api/auth/login' \
  -H 'Content-Type: application/json' \
  -d '{
    "factoryId": "F001",
    "username": "testadmin",
    "password": "123456"
  }' | python3 -m json.tool
```

### B. æ•°æ®åº“ä¿®å¤è„šæœ¬

å·²åˆ›å»ºä»¥ä¸‹SQLè„šæœ¬ç”¨äºä¿®å¤æ•°æ®åº“ï¼š
1. `init-database.sql` - åˆå§‹åŒ–æ•°æ®åº“å’Œæµ‹è¯•æ•°æ®
2. `alter-sessions-table.sql` - ä¿®æ”¹sessionsè¡¨å…è®¸factory_idä¸ºNULL
3. `fix-sessions-foreign-keys.sql` - åˆ é™¤user_idå¤–é”®çº¦æŸ

### C. ç›¸å…³æ–‡æ¡£
- [å¿«é€Ÿå¼€å§‹.md](å¿«é€Ÿå¼€å§‹.md) - åº”ç”¨å¯åŠ¨æŒ‡å—
- [åŠŸèƒ½å¯¹æ¯”æ£€æŸ¥æŠ¥å‘Š.md](åŠŸèƒ½å¯¹æ¯”æ£€æŸ¥æŠ¥å‘Š.md) - Node.js vs Spring Bootå¯¹æ¯”
- [APIæ¥å£æ–‡æ¡£.md](../APIæ¥å£æ–‡æ¡£.md) - å®Œæ•´APIæ–‡æ¡£

---

**æŠ¥å‘Šç”Ÿæˆæ—¶é—´**: 2025-10-10 15:30:00
**æµ‹è¯•å·¥å…·**: curl, python3, MySQL Client
**æ–‡æ¡£ç‰ˆæœ¬**: v1.0
